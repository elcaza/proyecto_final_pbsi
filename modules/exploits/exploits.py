from base64 import b64decode
import os

class Exploit():
    def __init__(self, parametros):
        self.set_nombre(parametros)
        self.set_contenido(parametros)
        self.set_software(parametros)
        self.set_cms(parametros)
        self.get_extension()
        self.get_ruta()

    def crear_archivo_exploit(self):
        with open(self.ruta+"/"+self.nombre,"wb") as archivo_exploit:
            archivo_exploit.write(b64decode(self.contenido))
        return True

    def get_extension(self):
        self.extension = self.nombre.split(".")
        if len(self.extension) == 1:
            self.extension = ""
            return self.extension
        self.extension = self.extension[-1]
        return self.extension

    def get_nombre(self):
        return self.nombre
    
    def get_contenido(self):
        return self.contenido

    def get_software(self):
        return self.software_nombre, self.software_version
        
    def get_cms(self):
        return self.cms_nombre, self.cms_categoria, self.cms_extension_nombre, self.cms_extension_version

    def get_ruta(self):
        self.ruta = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(os.path.dirname(__file__)))),"files")
        return self.ruta 

    def set_nombre(self,parametros):
        if "nombre" in parametros:
                self.nombre = parametros["nombre"]
        else:
            self.nombre = "exploit_generico.sh"
    
    def set_contenido(self,parametros):
        if "contenido" in parametros:
                self.contenido = parametros["contenido"]
        else:
            self.contenido = "ZWNobyAiRXhpdG8i"

    def set_software(self,parametros):
        if "software" in parametros:
                self.software_nombre = parametros["software"]["nombre"]
                self.software_version = parametros["software"]["version"]
        else:
            self.software_nombre = ""
            self.software_version = ""

    def set_cms(self,parametros):
        if "cms" in parametros:
                self.cms_nombre = parametros["cms"]["nombre_cms"]
                self.cms_categoria = parametros["cms"]["categoria"]
                self.cms_extension_nombre = parametros["cms"]["nombre_cms_extension"]
                self.cms_extension_version = parametros["cms"]["version"]
        else:
            self.cms_nombre = ""
            self.cms_categoria = ""
            self.cms_extension_nombre = ""
            self.cms_extension_version = ""

    def cargar_exploit_mongo(self):
        if self.software_nombre == "":
            return self.cargar_exploit_cms_mongo()
        return self.cargar_exploit_software_mongo()

    def cargar_exploit_software_mongo(self):
        return {
                "exploit":self.nombre,
                "ruta":self.ruta,    
                "software_nombre":self.software_nombre,
                "software_version":self.software_version
                }
    
    def cargar_exploit_cms_mongo(self):
        return {
                "exploit":self.nombre,
                "ruta":self.ruta,
                "cms_nombre":self.cms_nombre,
                "cms_categoria":self.cms_categoria,
                "cms_extension_nombre":self.cms_extension_nombre,
                "cms_extension_version":self.cms_extension_version        
                }

def execute(parametros):
    exploit = Exploit(parametros)
    exploit.crear_archivo_exploit()
    return exploit.cargar_exploit_mongo()

#con = Conector()
#con.exploit_cargar_datos(execute("exploit1.py","aG9sYSBqYWphaiBlcyBhdW5zZGFzbGRtIHFtMzQtaTEzeWU4Zy1kaXAyaDM0MjB7b2RueyAKcHJ1ZWJh","Javascript","Math",""))